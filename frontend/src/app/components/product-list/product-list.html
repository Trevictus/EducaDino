<section class="product-list">
  <header class="product-list__header">
    <h2 class="product-list__title">ü¶ñ Cat√°logo de Productos</h2>

    <!-- Formulario de b√∫squeda reactiva con debounce -->
    <div class="product-list__search">
      <div class="product-list__search-field">
        <span class="material-icons">search</span>
        <input
          type="text"
          [formControl]="searchControl"
          placeholder="Buscar productos..."
          class="product-list__input"
          aria-label="Buscar productos"
        />
      </div>

      <select
        [formControl]="categoryControl"
        class="product-list__select"
        aria-label="Filtrar por categor√≠a"
      >
        <option value="">Todas las categor√≠as</option>
        @for (category of store.categories().length ? store.categories() : defaultCategories; track category) {
          <option [value]="category">{{ category }}</option>
        }
      </select>

      <button
        type="button"
        class="product-list__btn product-list__btn--secondary"
        (click)="clearFilters()"
      >
        Limpiar
      </button>
    </div>
  </header>

  <!-- ============================================
       ESTADO: LOADING
       ============================================ -->
  @if (store.loading()) {
    <div class="product-list__loading" role="status" aria-live="polite">
      <div class="product-list__spinner">
        <div class="product-list__spinner-circle"></div>
      </div>
      <p class="product-list__loading-text">Cargando productos...</p>
      <span class="product-list__loading-emoji" aria-hidden="true">ü¶ï</span>
    </div>
  }

  <!-- ============================================
       ESTADO: ERROR
       ============================================ -->
  @if (store.hasError() && !store.loading()) {
    <div class="product-list__error">
      <app-alert
        type="error"
        [title]="'Error al cargar productos'"
        [dismissible]="true"
        (closed)="clearError()"
      >
        {{ store.error() }}
      </app-alert>

      <div class="product-list__error-actions">
        <button
          type="button"
          class="product-list__btn product-list__btn--primary"
          (click)="retry()"
        >
          <span class="material-icons">refresh</span>
          Reintentar
        </button>
      </div>
    </div>
  }

  <!-- ============================================
       ESTADO: EMPTY (Sin resultados)
       ============================================ -->
  @if (store.isEmpty() && !store.loading() && !store.hasError()) {
    <div class="product-list__empty">
      <div class="product-list__empty-icon">
        <span class="material-icons">inventory_2</span>
      </div>
      <h3 class="product-list__empty-title">No se encontraron productos</h3>
      <p class="product-list__empty-text">
        @if (searchControl.value || categoryControl.value) {
          No hay productos que coincidan con tu b√∫squeda.
          <br />
          Intenta con otros t√©rminos o categor√≠a.
        } @else {
          A√∫n no hay productos disponibles en el cat√°logo.
        }
      </p>
      <button
        type="button"
        class="product-list__btn product-list__btn--secondary"
        (click)="clearFilters()"
      >
        Ver todos los productos
      </button>
    </div>
  }

  <!-- ============================================
       ESTADO: SUCCESS (Lista de productos)
       ============================================ -->
  @if (store.filteredCount() > 0 && !store.loading() && !store.hasError()) {
    <!-- Info de resultados -->
    <div class="product-list__info">
      <span class="product-list__count">
        {{ store.filteredCount() }} productos encontrados
      </span>

      <!-- Controles de ordenamiento -->
      <div class="product-list__sort">
        <span>Ordenar por:</span>
        <button
          type="button"
          class="product-list__sort-btn"
          (click)="sortBy('name')"
        >
          Nombre
          <span class="material-icons">{{ getSortIcon('name') }}</span>
        </button>
        <button
          type="button"
          class="product-list__sort-btn"
          (click)="sortBy('price')"
        >
          Precio
          <span class="material-icons">{{ getSortIcon('price') }}</span>
        </button>
      </div>
    </div>

    <!-- Grid de productos con trackBy para rendimiento -->
    <div class="product-list__grid">
      @for (product of store.paginatedProducts(); track product.id) {
        <article
          class="product-card"
          (click)="onProductClick(product)"
          tabindex="0"
          role="button"
          [attr.aria-label]="'Ver ' + product.name"
        >
          <div class="product-card__image-wrapper">
            <img
              [src]="product.image"
              [alt]="product.name"
              class="product-card__image"
              loading="lazy"
            />
            @if (product.featured) {
              <span class="product-card__badge">‚≠ê Destacado</span>
            }
          </div>

          <div class="product-card__content">
            <h3 class="product-card__title">{{ product.name }}</h3>
            <p class="product-card__category">{{ product.category }}</p>
            <p class="product-card__description">{{ product.description }}</p>

            <div class="product-card__footer">
              <span class="product-card__price">{{ product.price | currency: 'EUR' }}</span>
              <span
                class="product-card__stock"
                [class.product-card__stock--low]="product.stock < 10"
              >
                {{ product.stock }} en stock
              </span>
            </div>

            <div class="product-card__actions">
              <button
                type="button"
                class="product-card__action-btn"
                (click)="onEditProduct(product, $event)"
                aria-label="Editar producto"
              >
                <span class="material-icons">edit</span>
              </button>
              <button
                type="button"
                class="product-card__action-btn product-card__action-btn--danger"
                (click)="onDeleteProduct(product, $event)"
                aria-label="Eliminar producto"
              >
                <span class="material-icons">delete</span>
              </button>
            </div>
          </div>
        </article>
      }
    </div>

    <!-- Paginaci√≥n -->
    @if (store.totalPages() > 1) {
      <nav class="product-list__pagination" aria-label="Paginaci√≥n de productos">
        <button
          type="button"
          class="product-list__page-btn"
          [disabled]="!store.hasPreviousPage()"
          (click)="previousPage()"
          aria-label="P√°gina anterior"
        >
          <span class="material-icons">chevron_left</span>
        </button>

        <span class="product-list__page-info">
          P√°gina {{ store.viewState().pagination.currentPage }} de {{ store.totalPages() }}
        </span>

        <button
          type="button"
          class="product-list__page-btn"
          [disabled]="!store.hasNextPage()"
          (click)="nextPage()"
          aria-label="P√°gina siguiente"
        >
          <span class="material-icons">chevron_right</span>
        </button>
      </nav>
    }
  }
</section>

