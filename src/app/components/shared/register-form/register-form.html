<form
  class="register-form"
  [formGroup]="registerForm"
  (ngSubmit)="onSubmit()">

  <h2 class="register-form__title">Crear cuenta</h2>

  <!-- DATOS PERSONALES -->
  <fieldset class="register-form__section">
    <legend class="register-form__legend">Datos personales</legend>

    <!-- Nombre completo -->
    <div class="form-field" [class.form-field--error]="hasError('nombre')">
      <label for="reg-nombre" class="form-field__label">
        Nombre completo <span class="form-field__required">*</span>
      </label>
      <input
        type="text"
        id="reg-nombre"
        formControlName="nombre"
        class="form-field__input"
        placeholder="Ej: María García">
      @if (hasError('nombre')) {
        <p class="form-field__error">{{ getErrorMessage('nombre') }}</p>
      }
    </div>

    <!-- Username -->
    <div class="form-field"
         [class.form-field--error]="hasError('username')"
         [class.form-field--pending]="isPending('username')">
      <label for="reg-username" class="form-field__label">
        Nombre de usuario <span class="form-field__required">*</span>
      </label>
      <input
        type="text"
        id="reg-username"
        formControlName="username"
        class="form-field__input"
        placeholder="ej: dinosaurio123">
      @if (isPending('username')) {
        <p class="form-field__pending">Comprobando disponibilidad...</p>
      }
      @if (hasError('username') && !isPending('username')) {
        <p class="form-field__error">{{ getErrorMessage('username') }}</p>
      }
    </div>

    <!-- NIF -->
    <div class="form-field" [class.form-field--error]="hasError('nif')">
      <label for="reg-nif" class="form-field__label">
        NIF/DNI <span class="form-field__required">*</span>
      </label>
      <input
        type="text"
        id="reg-nif"
        formControlName="nif"
        class="form-field__input"
        placeholder="12345678Z"
        maxlength="9">
      @if (hasError('nif')) {
        <p class="form-field__error">{{ getErrorMessage('nif') }}</p>
      }
    </div>

    <!-- Email -->
    <div class="form-field"
         [class.form-field--error]="hasError('email')"
         [class.form-field--pending]="isPending('email')">
      <label for="reg-email" class="form-field__label">
        Email <span class="form-field__required">*</span>
      </label>
      <input
        type="email"
        id="reg-email"
        formControlName="email"
        class="form-field__input"
        placeholder="tu@email.com">
      @if (isPending('email')) {
        <p class="form-field__pending">Verificando email...</p>
      }
      @if (hasError('email') && !isPending('email')) {
        <p class="form-field__error">{{ getErrorMessage('email') }}</p>
      }
      <p class="form-field__helper">Prueba con "test&#64;test.com" para ver el error asíncrono.</p>
    </div>
  </fieldset>

  <!-- CONTRASEÑA -->
  <fieldset class="register-form__section">
    <legend class="register-form__legend">Seguridad</legend>

    <!-- Password -->
    <div class="form-field" [class.form-field--error]="hasError('password')">
      <label for="reg-password" class="form-field__label">
        Contraseña <span class="form-field__required">*</span>
      </label>
      <div class="form-field__password-wrapper">
        <input
          [type]="showPassword ? 'text' : 'password'"
          id="reg-password"
          formControlName="password"
          class="form-field__input"
          placeholder="Mínimo 8 caracteres">
        <button
          type="button"
          class="form-field__toggle-password"
          (click)="togglePasswordVisibility('password')"
          [attr.aria-label]="showPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'">
          <span class="material-icons">{{ showPassword ? 'visibility_off' : 'visibility' }}</span>
        </button>
      </div>

      <!-- Requisitos de contraseña -->
      <ul class="password-requirements">
        @for (req of getPasswordRequirements(); track req.label) {
          <li [class.password-requirements--valid]="req.valid"
              [class.password-requirements--invalid]="!req.valid && f['password'].dirty">
            <span class="material-icons">{{ req.valid ? 'check_circle' : 'radio_button_unchecked' }}</span>
            {{ req.label }}
          </li>
        }
      </ul>
    </div>

    <!-- Confirm Password -->
    <div class="form-field" [class.form-field--error]="hasError('confirmPassword')">
      <label for="reg-confirm-password" class="form-field__label">
        Confirmar contraseña <span class="form-field__required">*</span>
      </label>
      <div class="form-field__password-wrapper">
        <input
          [type]="showConfirmPassword ? 'text' : 'password'"
          id="reg-confirm-password"
          formControlName="confirmPassword"
          class="form-field__input"
          placeholder="Repite la contraseña">
        <button
          type="button"
          class="form-field__toggle-password"
          (click)="togglePasswordVisibility('confirm')"
          [attr.aria-label]="showConfirmPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'">
          <span class="material-icons">{{ showConfirmPassword ? 'visibility_off' : 'visibility' }}</span>
        </button>
      </div>
      @if (hasError('confirmPassword')) {
        <p class="form-field__error">{{ getErrorMessage('confirmPassword') }}</p>
      }
    </div>
  </fieldset>

  <!-- TÉRMINOS -->
  <div class="form-field form-field--checkbox" [class.form-field--error]="hasError('acceptTerms')">
    <label class="form-field__checkbox-label">
      <input
        type="checkbox"
        formControlName="acceptTerms"
        class="form-field__checkbox">
      <span>Acepto los <a href="/terminos" target="_blank">términos y condiciones</a></span>
    </label>
    @if (hasError('acceptTerms')) {
      <p class="form-field__error">{{ getErrorMessage('acceptTerms') }}</p>
    }
  </div>

  <!-- SUBMIT -->
  <div class="register-form__actions">
    <button
      type="submit"
      class="btn-submit btn-submit--primary"
      [disabled]="registerForm.invalid || isSubmitting">
      @if (isSubmitting) {
        <span class="btn-submit__spinner"></span>
        Creando cuenta...
      } @else {
        Crear cuenta
      }
    </button>
  </div>

</form>
