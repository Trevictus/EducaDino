import{a as s,b as d}from"./chunk-TGME2SXI.js";import{l as m}from"./chunk-4RMWBARQ.js";import{F as i,J as g,Mb as o,O as u,ea as c,i as n,u as l}from"./chunk-5N3JP377.js";var f=class a{api=u(d);router=u(m);_currentUser=c(null);_isLoading=c(!1);currentUser=this._currentUser.asReadonly();isLoading=this._isLoading.asReadonly();isAuthenticated=o(()=>!!this._currentUser());isAdmin=o(()=>this._currentUser()?.role==="ADMIN");username=o(()=>this._currentUser()?.username??"");constructor(){this.loadStoredUser()}login(t){return this._isLoading.set(!0),this.api.post("/auth/login",t).pipe(i(e=>{if(e.success&&e.token){localStorage.setItem(s.tokenKey,e.token);let r={id:0,username:e.username,email:e.email,role:e.role,profileImage:e.profileImage,level:e.level,learningTime:e.learningTime,completedMinigames:e.completedMinigames,totalScore:e.totalScore};localStorage.setItem("educadino_user",JSON.stringify(r)),this._currentUser.set(r),console.log("[AuthService] Login exitoso:",r.username)}this._isLoading.set(!1)}),l(e=>(this._isLoading.set(!1),console.error("[AuthService] Error en login:",e),n(()=>e))))}register(t){return this._isLoading.set(!0),this.api.post("/auth/register",t).pipe(i(e=>{if(e.success&&e.token){localStorage.setItem(s.tokenKey,e.token);let r={id:0,username:e.username,email:e.email,role:e.role,level:e.level,learningTime:e.learningTime,completedMinigames:e.completedMinigames,totalScore:e.totalScore};localStorage.setItem("educadino_user",JSON.stringify(r)),this._currentUser.set(r),console.log("[AuthService] Registro exitoso:",r.username)}this._isLoading.set(!1)}),l(e=>(this._isLoading.set(!1),console.error("[AuthService] Error en registro:",e),n(()=>e))))}resetPassword(t){return this.api.post("/auth/reset-password",t)}logout(){localStorage.removeItem(s.tokenKey),localStorage.removeItem("educadino_user"),this._currentUser.set(null),this.router.navigate(["/login"]),console.log("[AuthService] Sesi\xF3n cerrada")}getProfile(){return this.api.get("/users/me").pipe(i(t=>{t.success&&(this._currentUser.set(t.data),localStorage.setItem("educadino_user",JSON.stringify(t.data)))}))}updateProfile(t){return this.api.put("/users/me",t).pipe(i(e=>{e.success&&(this._currentUser.set(e.data),localStorage.setItem("educadino_user",JSON.stringify(e.data)))}))}loadStoredUser(){let t=localStorage.getItem(s.tokenKey),e=localStorage.getItem("educadino_user");if(t&&e)try{let r=JSON.parse(e);this._currentUser.set(r),console.log("[AuthService] Sesi\xF3n recuperada:",r.username)}catch{this.logout()}}isTokenExpired(){let t=localStorage.getItem(s.tokenKey);if(!t)return!0;try{let r=JSON.parse(atob(t.split(".")[1])).exp*1e3;return Date.now()>=r}catch{return!0}}getToken(){return localStorage.getItem(s.tokenKey)}static \u0275fac=function(e){return new(e||a)};static \u0275prov=g({token:a,factory:a.\u0275fac,providedIn:"root"})};export{f as a};
